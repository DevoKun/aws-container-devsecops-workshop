


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="This workshop is designed to help attendees understand the security concerns of container images and learn how to create a devsecops pipeline for securely building and releasing images.">
      
      
        <link rel="canonical" href="https://container-devsecops.awssecworkshops.com/04-testing/">
      
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>Module 4: Pipeline Testing - Integrating security into your container pipeline</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.63b94e9e.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-4-pipeline-testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://container-devsecops.awssecworkshops.com/" title="Integrating security into your container pipeline" class="md-header-nav__button md-logo" aria-label="Integrating security into your container pipeline">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Integrating security into your container pipeline
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Module 4: Pipeline Testing
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/aws-samples/aws-container-devsecops-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/aws-container-devsecops-workshop
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://container-devsecops.awssecworkshops.com/" title="Integrating security into your container pipeline" class="md-nav__button md-logo" aria-label="Integrating security into your container pipeline">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    Integrating security into your container pipeline
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/aws-container-devsecops-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/aws-container-devsecops-workshop
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../00-env-setup/" title="Module 0: Environment Setup" class="md-nav__link">
      Module 0: Environment Setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-linting/" title="Module 1: Dockerfile Linting" class="md-nav__link">
      Module 1: Dockerfile Linting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02-secrets-scanning/" title="Module 2: Secrets Scanning" class="md-nav__link">
      Module 2: Secrets Scanning
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../03-vuln-scanning/" title="Module 3: Vulnerability Scanning" class="md-nav__link">
      Module 3: Vulnerability Scanning
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 4: Pipeline Testing
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Module 4: Pipeline Testing" class="md-nav__link md-nav__link--active">
      Module 4: Pipeline Testing
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipeline-architecture" class="md-nav__link">
    Pipeline Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-a-commit" class="md-nav__link">
    Make a commit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-pull-request" class="md-nav__link">
    Create a Pull Request
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-the-feedback-loop" class="md-nav__link">
    View the feedback loop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fix-the-dockerfile-linting-defects" class="md-nav__link">
    Fix the Dockerfile linting defects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove-secrets" class="md-nav__link">
    Remove secrets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-vulnerabilities" class="md-nav__link">
    View vulnerabilities
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-image" class="md-nav__link">
    View Image
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../05-cleanup/" title="Module 5: Cleanup" class="md-nav__link">
      Module 5: Cleanup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipeline-architecture" class="md-nav__link">
    Pipeline Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-a-commit" class="md-nav__link">
    Make a commit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-pull-request" class="md-nav__link">
    Create a Pull Request
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-the-feedback-loop" class="md-nav__link">
    View the feedback loop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fix-the-dockerfile-linting-defects" class="md-nav__link">
    Fix the Dockerfile linting defects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove-secrets" class="md-nav__link">
    Remove secrets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-vulnerabilities" class="md-nav__link">
    View vulnerabilities
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-image" class="md-nav__link">
    View Image
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-container-devsecops-workshop/edit/master/docs/04-testing.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-4-pipeline-testing">Module 4 <small>Pipeline Testing</small></h1>
<p><strong>Time</strong>: 50 minutes</p>
<p>Now that you have integrated multiple types of security testing into your pipeline you can test it to ensure your stages are effective in properly evaluating the security of your container-based applications.  While going through each stage you will fix any misconfiguration or vulnerability so that your sample application is able to successfully pass through each stage and is pushed to AWS ECR.</p>
<h2 id="pipeline-architecture">Pipeline Architecture</h2>
<p><img alt="Architecture" src="../images/04-arch.png" title="Pipeline Architecture" /></p>
<ol>
<li><strong>Commit</strong>: Developer makes a commit to the <em>Development</em> branch.</li>
<li><strong>Pull Request</strong>: Developer makes a Pull Request<ul>
<li>Source Branch: <em>Developement</em></li>
<li>Destination Branch: <em>Master</em></li>
</ul>
</li>
<li><strong>Triggers Rule</strong>: A CloudWatch Event Rule is triggered based on the following events:<ul>
<li><em>pullRequestSourceBranchUpdated</em></li>
<li><em>pullRequestCreated</em></li>
</ul>
</li>
<li><strong>Invokes Function</strong>: The AWS Lambda Function is setup as a target for the CloudWatch Event Rule and it is invoked after the CloudWatch Event Rule is triggered</li>
<li>
<p><strong>Posts comment</strong>: The Lambda Function posts a comment to the Pull Request stating that the security testing is starting.</p>
<p><strong>Starts Pipeline</strong>:  The Lambda Function starts the CodePipeline.</p>
</li>
<li>
<p><strong>Pull Request Stage</strong>: The stage pulls in these sources and stores them as artifacts in S3;</p>
<ul>
<li>CodeCommit repository: <em>container-devsecops-wksp-app (development branch)</em></li>
<li>CodeCommit repository: <em>container-devsecops-wksp-config (master branch)</em></li>
</ul>
</li>
<li><strong>Dockerfile Linting Stage</strong>: The stage pulls in the artifacts from S3 and uses Hadolint (build spec file and configuration file pulled in from S3) to lint the Dockerfile to ensure it adheres to best practices.</li>
<li><strong>Secrets Scanning Stage</strong>: The stage runs high signal regex checks directly against the CodeCommit Repository (<em>container-devsecops-wksp-app - development branch</em>)</li>
<li><strong>Vulnerability Scanning Stage</strong>: The stage builds the container image, pushes it to ECR, and triggers an Anchore vulnerability assessment against the image.  If the scan results include any vulnerabilites that meet or exceed the threshold the build fails.  If the vulnerabilites are lower than the threshold the CodeBuild project will invoke a Lambda function with the scan results as the payload and the Lambda function will push the vulnerabilites into AWS Security Hub for future triaging since the risk for those have been accepted.</li>
<li><strong>Publish Imaeg</strong>: The last stage builds the image using the destination commit hash as the tag and publishes it to AWS ECR.</li>
<li><strong>CodeBuild Triggers</strong>: If any CodeBuild Project fails a CloudWatch Event Rule is triggered.</li>
<li><strong>Triggers Lambda Function</strong>: The Lambda Function is setup as a target for the CloudWatch Event Rule and is invoked after the CloudWatch Event Rule is triggered.</li>
<li><strong>Adds Feedback to Pull Request</strong>:  The Lambda Function takes the results from each stage and CodeBuild project and posts a comment back to the Pull Requst.  This gives the developers fast feedback so they're able to fix any issues that are identified through the pipeline.</li>
</ol>
<h2 id="make-a-commit">Make a commit</h2>
<p>Now you can test your pipeline to see how your Pull Requests result with an image being built and pushed to AWS ECR. First, make a commit to the <em>development branch</em> of your sample application</p>
<ol>
<li>Within your Cloud9 IDE expand your <strong>sample application</strong> on the left side.</li>
<li>Open the <strong>Dockerfile</strong>.</li>
<li>Add a name to the Label line.</li>
<li>Update the version for <code>sqlite-libs</code> to the latest version published at <a href="https://pkgs.alpinelinux.org/package/edge/main/x86/sqlite-libs">Alpine Linux Repo</a>. Please, copy the whole version string, similar to, <code>3.26.0-r3</code>. </li>
<li>Push your commit.</li>
</ol>
<div class="codehilite"><pre><span></span><code>    <span class="nb">cd</span> /home/ec2-user/environment/sample-application
    git add Dockerfile
    git commit -m <span class="s2">&quot;Modified Maintainer in Dockerfile&quot;</span>
    git push -u origin development
</code></pre></div>


<h2 id="create-a-pull-request">Create a Pull Request</h2>
<div class="codehilite"><pre><span></span><code>aws codecommit create-pull-request <span class="se">\</span>
    --title <span class="s2">&quot;Updated Maintainer&quot;</span> <span class="se">\</span>
    --description <span class="s2">&quot;Please review these changes.&quot;</span> <span class="se">\</span>
    --targets <span class="nv">repositoryName</span><span class="o">=</span>container-devsecops-wksp-app,sourceReference<span class="o">=</span>development,destinationReference<span class="o">=</span>master
</code></pre></div>


<p>Go to your <a href="https://us-east-2.console.aws.amazon.com/codesuite/codepipeline/pipelines/container-devsecops-wksp-pipeline/view" target="_blank">AWS CodePipeline</a> to view the progress and result.</p>
<h2 id="view-the-feedback-loop">View the feedback loop</h2>
<p>Each time a stage is run the results of the CodeBuild Project are posted back to the Pull Request to act as a feedback loop for developers.</p>
<ol>
<li>Go to the <a href="https://us-east-2.console.aws.amazon.com/codesuite/codecommit/repositories/container-devsecops-wksp-app/pull-requests?region=us-east-2&status=OPEN" target="_blank">CodeCommit console</a></li>
<li>Click on the latest Pull Request.</li>
<li>Click the <strong>Activity</strong> tab to view the feedback.</li>
</ol>
<h2 id="fix-the-dockerfile-linting-defects">Fix the Dockerfile linting defects</h2>
<p>In the feedback you should see multiple defects that were identified by the Dockerfile linting stage.  The first defect can be fixed by modifying the hadolint configuration.</p>
<ol>
<li>
<p>Click on your Cloud9 IDE tab.</p>
</li>
<li>
<p>In the left file tree, expand the <strong>configurations</strong> folder and open <strong>hadolint.yml</strong>.</p>
</li>
<li>
<p>Fix the defect:</p>
<div class="admonition info">
<p class="admonition-title">Use of untrusted images</p>
<p><strong>DL3026</strong>: Use only an allowed registry in the FROM image</p>
<p><strong>Description</strong>:  Using externally provided images can result in the same types of risks that external software traditionally has, such as introducing malware, leaking data, or including components with vulnerabilities. To prevent the use of externally provided images you should only pull images from trusted registries.</p>
<p><strong>Fix*<em>: Add <code>- docker.io</code> under </em></strong>trustedRegistries***.  </p>
<p><strong>Explanation</strong>:  Since the image is pulling from Dockerhub we can include it on the list so that the build is able to pass.  Adding Dockerhub is purely for testing purposes, in reality you would whitelist trusted registries that you host yourself or registries hosted by trusted 3rd parties.</p>
<p><strong>Reference</strong>: <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf" target="_blank">NIST SP 800-190: Application Container Security Guide - 3.1.5</a></p>
</div>
</li>
<li>
<p>Commit your configuration changes:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> /home/ec2-user/environment/configurations
git add .
git commit -m <span class="s2">&quot;Added a trusted registry to hadolint configuration.&quot;</span>
git push -u origin master
</code></pre></div>


<p>The next two defects can be fixed by modifying the Dockerfile.</p>
<ol>
<li>
<p>In the left file tree, expand the <strong>sample-application</strong> folder and open <strong>Dockerfile</strong>.</p>
</li>
<li>
<p>Fix the defects:</p>
<div class="admonition info">
<p class="admonition-title">Image configuration defects</p>
<p><strong>DL3002</strong>: Last USER should not be root.</p>
<p><strong>Description</strong>: To adhere the principals of least privileges, your containers should not be running as root.  Most containerized processes are application services and therefore don’t require root access. </p>
<p><strong>Fix</strong>: Change USER to a non privileged user.  Add the following to the Dockerfile <strong>underneath RUN apk</strong>:</p>
<p><code>RUN addgroup -S sasquatch</code></p>
<p><code>RUN adduser -S sasquatch -G sasquatch</code></p>
<p>Next, replace <code>USER root</code> with <code>USER sasquatch</code></p>
<p><strong>Explanation</strong>: By creating a user in your Dockerfile, you are making it not only secure by default but also easier to keep secure.</p>
<p><strong>Reference</strong>: <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf" target="_blank">NIST SP 800-190: Application Container Security Guide - 3.1.2</a></p>
</div>
<div class="admonition info">
<p class="admonition-title">Image configuration defects</p>
<p><strong>DL3007</strong>: Using latest is prone to errors if the image will ever update.</p>
<p><strong>Description</strong>: Latest is just a tag you add to an image and is no way dynamic.  It can be overwritten and prove difficult to understand what version of the software is installed.  Using the latest tag can effect the availability of your application and you should look at using a more explicit tag. </p>
<p><strong>Fix</strong>: Pin the version explicitly to a release tag.  </p>
<p>Replace <code>FROM python:latest</code> with <code>FROM python:3.7-alpine</code></p>
<p><strong>Reference</strong>: <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf" target="_blank">NIST SP 800-190: Application Container Security Guide - 3.1.2</a></p>
</div>
</li>
</ol>
<p>Commit your application source code changes:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> /home/ec2-user/environment/sample-application
git add Dockerfile
git commit -m <span class="s2">&quot;Fixed Dockerfile linting issues.&quot;</span>
git push -u origin development
</code></pre></div>


<p>Go to your <a href="https://us-east-2.console.aws.amazon.com/codesuite/codepipeline/pipelines/container-devsecops-wksp-pipeline/view" target="_blank">AWS CodePipeline</a> to view the progress and result.</p>
<p><strong>View the Pull Request Feedback</strong></p>
<p>Updating the Pull Request branch automatically triggers the pipeline again.  You can view the feedback to see if the defects were remediated.</p>
<ol>
<li>Go to the <a href="https://us-east-2.console.aws.amazon.com/codesuite/codecommit/repositories/container-devsecops-wksp-app/pull-requests?region=us-east-2&status=OPEN" target="_blank">CodeCommit console</a></li>
<li>Click on the latest Pull Request.</li>
<li>Click the <strong>Activity</strong> tab to view the feedback.</li>
</ol>
<h2 id="remove-secrets">Remove secrets</h2>
<p>Based on the feedback you received in the Pull request you can see that secrets were identified in your code.  </p>
<ol>
<li>
<p>Click on <strong>Logs</strong> in the comment or view the CodeBuild Project history to identify the secret and the file it is located in.</p>
<div class="admonition question">
<p class="admonition-title">How could you improve the feedback loop to make it easier for the developer?</p>
</div>
</li>
<li>
<p>Remove the secret from the file.</p>
</li>
</ol>
<p><strong>Modify trufflehog configuration</strong></p>
<p>Currently your trufflehog configuration is scanning through all of your commits to identify secrets. Since you'll be removing any current secrets you can modify the configuration to only scan new commits to speed up the build.</p>
<ol>
<li>
<p>In the left file tree, expand the <strong>configurations</strong> folder and open <strong>buildspec_secrets.yml</strong>.</p>
</li>
<li>
<p>Update your trufflehog configuration to only scan 1 commit deep.</p>
</li>
</ol>
<p>Change this command:</p>
<p>- trufflehog --regex --rules secrets_config.json --entropy=False "$APP_REPO_URL"</p>
<p>To this:</p>
<div class="codehilite"><pre><span></span><code>- trufflehog --regex --rules secrets_config.json --entropy<span class="o">=</span>False --max_depth <span class="m">1</span> <span class="s2">&quot;</span><span class="nv">$APP_REPO_URL</span><span class="s2">&quot;</span>
</code></pre></div>


<div class="admonition info">
<p class="admonition-title">The second line adds "--max-depth 1" which limits the scan depth.</p>
</div>
<p>Commit your configuration changes:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> /home/ec2-user/environment/configurations
git add .
git commit -m <span class="s2">&quot;Modifed max-depth in trufflehog command.&quot;</span>
git push -u origin master
</code></pre></div>


<p>Commit your application changes:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> /home/ec2-user/environment/sample-application
git add .
git commit -m <span class="s2">&quot;Removed access key.&quot;</span>
git push -u origin development
</code></pre></div>


<p>Go to your <a href="https://us-east-2.console.aws.amazon.com/codesuite/codepipeline/pipelines/container-devsecops-wksp-pipeline/view" target="_blank">AWS CodePipeline</a> to view the progress and result.</p>
<p><strong>View the Pull Request Feedback</strong></p>
<p>Updating the Pull Request branch automatically triggers the pipeline again.  You can view the feedback to see if the defects were remediated.</p>
<ol>
<li>Go to the <a href="https://us-east-2.console.aws.amazon.com/codesuite/codecommit/repositories/container-devsecops-wksp-app/pull-requests?region=us-east-2&status=OPEN" target="_blank">CodeCommit console</a></li>
<li>Click on the latest Pull Request.</li>
<li>Click the <strong>Activity</strong> tab to view the feedback.</li>
</ol>
<p>You'll notice that your pipeline is still failing on the secrets stage.  If you look at the commit that's being scanned you'll see that the access key still exists in that commit because it is part of the diff. Make one more commit and you'll see that your build passes the secret scanning stage successfully.</p>
<ol>
<li>
<p>In the left file tree, expand the <strong>sample-application</strong> folder and open <strong>Dockerfile</strong>.</p>
</li>
<li>
<p>Change the Label to the following:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>LABEL <span class="nv">maintainer</span><span class="o">=</span><span class="s2">&quot;Sasquatch&quot;</span> <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span>
</code></pre></div>


<p>Commit your application source code changes:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> /home/ec2-user/environment/sample-application
git add Dockerfile
git commit -m <span class="s2">&quot;Added version Label.&quot;</span>
git push -u origin development
</code></pre></div>


<div class="admonition info">
<p class="admonition-title">Embedded clear text secrets</p>
<p><strong>Description</strong>: Many applications require secrets to enable communication with other serivces or backend components.  When an application is packaged into an image, these secrets can be embedded directly into the image.  This creates a security risk in which anyone with access to the image can easily obtain the secrets.</p>
<p><strong>Fix</strong>: Remove secrets from source code and leverage a secure solution for managing secrets like <a href="https://aws.amazon.com/secrets-manager/" target="_blank">AWS Secrets Manager</a> or <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" target="_blank">AWS Systems Manager Parameter Store</a>.</p>
<p><strong>Explanation</strong>: Best practice is to the remove secrets from all previous commits and rotate any credential found but due to time constraints you removed the secret and modified the scanning tool to only scan new commits.</p>
<p><strong>Reference</strong>: <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf" target="_blank">NIST SP 800-190: Application Container Security Guide - 3.1.4</a></p>
</div>
<p><strong>View the Pull Request Feedback</strong></p>
<p>Updating the Pull Request branch automatically triggers the pipeline again.  You can view the feedback to see if the defects were remediated.</p>
<ol>
<li>Go to the <a href="https://us-east-2.console.aws.amazon.com/codesuite/codecommit/repositories/container-devsecops-wksp-app/pull-requests?region=us-east-2&status=OPEN" target="_blank">CodeCommit console</a></li>
<li>Click on the latest Pull Request.</li>
<li>Click the <strong>Activity</strong> tab to view the feedback.</li>
</ol>
<h2 id="view-vulnerabilities">View vulnerabilities</h2>
<p>In the feedback you should see information regarding any vulnerabilities that were found in the image.  When you went through the environment setup you specified a vulnerability threshold of <strong>"High"</strong>, which means that the build will fail if an image contains any High or Critical vulnerabilities. Specifying a threshold allows you to put in a place a risk tolerance for different severities of vulnerabilities. This allows your developers to continue to move quickly with low risk vulnerabilities that can be triaged and fixed later on.  In the current setup, all vulnerabilities below the threshold will be pushed to AWS Security Hub.</p>
<p>Since the build fails the vulnerability analysis stage we need to fix the issue with so that the image does not contain any <strong>"High"</strong> rated vulnerabilitiy.</p>
<ol>
<li>
<p>Go to the <a href="https://us-east-2.console.aws.amazon.com/securityhub/" target="_blank">Security Hub</a> console.</p>
</li>
<li>
<p>Click <strong>Findings</strong> in the left navigation</p>
</li>
<li>
<p>Click the search field and select a filter of <strong>Product Name</strong> EQUALS <strong>Default</strong>. The resulting findings are all of the vulnerabilities found in the image.</p>
</li>
<li>
<p>Click on the <strong>HIGH</strong> rated vulnerability and check the <strong>Description</strong> for the vulnerability reported. E.g.</p>
<p><img alt="vuln-description" src="../images/04-vuln-description.png" /></p>
<p>Follow the URL in the <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-8457"><strong>Source URL</strong></a> to see additional information about the reported vulnerability.</p>
<p>See the recommended <strong>Remediation</strong>. E.g.</p>
<p><img alt="vuln-remediation" src="../images/04-vuln-remediation.png" /></p>
</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Image vulnerabilities<p><strong>Description</strong>: Images are static archive files that include all of the components used to run an application.  Components within an image may be missing critical security updates or be outdated which can lead to exploitation and unauthorized system access.</p>
<p><strong>Fix</strong>: Containers should be looked at as immutable and as such shouldn't be patched directly. Instead the vulernabilities should be fixed upstream in the source code and configuration of the image and then the image should be rebuilt and published.  This ensures that all new containers instantiated from the image don't include the vulnerabilities.</p>
<p>Update the affected package in Dockerfile:
Following the recommended <strong>Remediation</strong> update the <code>sqlite</code> version to <code>3.28.0-r0</code> in the Dockerfile.</p>
<p><code>RUN apk add --no-cache sqlite-libs=3.28.0-r0</code></p>
<p><strong>Reference</strong>: <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf" target="_blank">NIST SP 800-190: Application Container Security Guide - 3.1.1</a></p>
</p>
</div>
<p>Commit your application source code changes:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> /home/ec2-user/environment/sample-application
git add Dockerfile
git commit -m <span class="s2">&quot;Update sqlite version to fix CVE-2019-8457&quot;</span>
git push -u origin development
</code></pre></div>


<p><strong>View the CodePipeline</strong></p>
<p>Updating the Pull Request branch automatically triggers the pipeline again.  This time go to the pipeline to view your code progress through the security testing.</p>
<ol>
<li>Go to the <a href="https://us-east-2.console.aws.amazon.com/codesuite/codepipeline/pipelines/container-devsecops-wksp-pipeline/view" target="_blank">CodePipeline console</a></li>
<li>Scroll down as your code progresses through each stage.</li>
</ol>
<h2 id="view-image">View Image</h2>
<p>The last stage of the pipeline builds the image, publishes it to AWS ECR, and then merges athe Pull Request.  You'll see in the feedback that a message is posted regarding the outcome of this stage and you'll notice that the Pull Request has been merged.</p>
<ol>
<li>Go to the <a href="https://us-east-2.console.aws.amazon.com/codesuite/codecommit/repositories/container-devsecops-wksp-app/pull-requests?region=us-east-2&status=Closed" target="_blank">CodeCommit console</a></li>
<li>Click on the latest Pull Request.  You may need to change the filter to "Closed Pull Requests" since the last stage publishes the image, merges the code, and closes the PR.</li>
<li>Click the <strong>Activity</strong> tab to view the feedback.</li>
<li>Click the <strong>AWS ECR repository</strong> link.</li>
</ol>
<p>Following tagging best practices, your image is tagged with the Git commit hash of your application.</p>
<hr />
<p>Congratulations!  You've completed the <strong>Integrating security into your container pipeline</strong> workshop. You now have a CI/CD pipeline for securely building and publishing your container-based applications. You can proceed to the next module to clean up the resources in your account.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../03-vuln-scanning/" title="Module 3: Vulnerability Scanning" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 3: Vulnerability Scanning
              </div>
            </div>
          </a>
        
        
          <a href="../05-cleanup/" title="Module 5: Cleanup" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 5: Cleanup
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a href="https://aws.amazon.com/privacy/" target="_blank">Privacy</a> | <a href="https://aws.amazon.com/terms/" target="_blank">Site terms</a> | &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M280.37 148.26L96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V300L295.67 148.26a12.19 12.19 0 00-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19 0 0115.3 0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M466.5 83.7l-192-80a48.15 48.15 0 00-36.9 0l-192 80C27.7 91.1 16 108.6 16 128c0 198.5 114.5 335.7 221.5 380.3 11.8 4.9 25.1 4.9 36.9 0C360.1 472.6 496 349.3 496 128c0-19.4-11.7-36.9-29.5-44.3zM256.1 446.3l-.1-381 175.9 73.3c-3.3 151.4-82.1 261.1-175.8 307.7z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>